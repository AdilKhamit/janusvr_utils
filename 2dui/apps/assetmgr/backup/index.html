<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Asset Manager</title>
    <meta name="description" content="JanusVR Interface Settings Menu">
    <meta name="author" content="JanusVR Inc.">
    <script src="../../../scripts/tabs.js"></script>
    <script src="lib/jquery-3.0.0.min.js"></script>
    <script src="lib/jquery.form.min.js"></script>
    <script src="lib/ipfs.js"></script>

    <script>
      ipfs.setProvider({host: 'strandedout.space', port: '5001'});
      ipfs.api.id(function (err, res) {
        if (err) {
          console.log('Error connecting to ipfs');
          return;
        }

        console.log('Connected to ipfs');


        ipfs.add('this is a test ^-^', function(err, hash) {
          if (err) {
            console.log('Error uploading file');
            return;
          }

          console.log('File uploaded: ' + hash);
        })
      });
    </script>

    <script>
      function clickSound() {
        document.getElementById('sound1').play();
      }

      function levelSound() {
        document.getElementById('sound2').play();
      }

      function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires="+d.toUTCString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
      }

      function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i = 0; i < ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }

      $(document).ready(function() {

        var pendingFrames = [];

        window.addEventListener('message', function(ev) {
          var i = pendingFrames.indexOf(ev.source);

          if (i == -1)
            return;

          var win = pendingFrames.splice(i,1);

          assetMgr.refreshFolder();
        }, false);

        function handleFileSelect(evt) {

          var files = evt.target.files; // FileList object

          var file = files[0];

        //  var reader = new FileReader();
        //  reader.onload = function(e) {
          //  var result = e.target.result;
            /*alert(result);

            var req = new XMLHttpRequest();
            req.open('POST', 'http://strandedin.space:8081/asset/', true);
            req.onload = function() { alert('Upload complete!') };
            req.send('hi!');*/

            var fileInput = $('input[type="file"]');
            //var submitInput = $('input[type="submit"]');

            var form = $('<form></form>');
            form.attr({
              id: 'formnigga',
              method: 'post',
              action: 'http://strandedin.space:8081/asset/upload/',
              enctype : "multipart/form-data"
            });

            console.log(form[0].outerHTML);

            var iframe = document.createElement('iframe');
            document.body.appendChild(iframe);

            //iframe.contentWindow.uuid
            pendingFrames.push(iframe.contentWindow);

            var doc = iframe.contentWindow.document;

            doc.open();
            doc.write(form[0].outerHTML);
            doc.close();

            var form = doc.getElementsByTagName('form')[0];
            form.appendChild(fileInput[0]);
            //form.appendChild(submitInput[0]);
            /*var d = new FormData(form);
            d.append('assetfile', file, 'lolwut.jpg');
            d.append('test', 'lol');*/

            form.submit();

          //}

          //reader.readAsArrayBuffer(file);

          //document.getElementById('windowarea').innerHTML = '<ul>' + output.join('') + '</ul>';
        }

        document.getElementById('assetfile').addEventListener('change', handleFileSelect, false);
      });

    </script>

    <link rel="stylesheet" type="text/css" href="../../../skins/emerald/emeraldgenericwindow.css">
    <style>
      #dizzpet {
        padding-left: calc(50% - 64px);
        bottom: 48px;
        position:absolute;
        text-align:center;
        width:128px;
        image-rendering:optimizeSpeed;             /* Legal fallback */
        image-rendering:-moz-crisp-edges;          /* Firefox        */
        image-rendering:-o-crisp-edges;            /* Opera          */
        image-rendering:-webkit-optimize-contrast; /* Safari         */
        image-rendering:optimize-contrast;         /* CSS3 Proposed  */
        image-rendering:crisp-edges;               /* CSS4 Proposed  */
        image-rendering:pixelated;                 /* CSS4 Proposed  */
        -ms-interpolation-mode:nearest-neighbor;   /* IE8+           */
      }

      .windowarea {
        border-width: 0px;
      }

      #myprogress {
        background-repeat: no-repeat;
        font-family: "Open Sans Regular";
        color: rgba(215,232,148,1);
        background-image: url('progress.png') ;
        max-width:100%;
        width:calc(100% - 148px);
        font-size: 12px;

        border-color: rgb(32,70,49);
        border-width:1px;
        border-style:solid;
        height:calc(100% - 0px);
        display: inline-block;
        background-color: #2B382C;
        vertical-align: middle;
        padding: 7px 8px;
        margin: 4px 4px;
      }

      body {
        background-color: rgba(215,232,148,0.25);
      }

      .button {
        background-color:rgb(32,70,49);
        color: rgba(215,232,148,1);
      }

      .button:hover {
        color:rgb(32,70,49);
        background-color: rgba(215,232,148,1);
      }
    </style>
    <link rel="stylesheet" type="text/css" href="css/style.css" />

    <script>
      function AssetManager(options) {
        this.options = options;
        this.domElement = options.target;
        this.cache = {};

        this.host = options.host;
        this.port = options.port ? parseInt(options.port) : 80;

        this.baseurl = 'http://' + this.host + ':' + this.port + '/';

        // Click and dragging
        this.domElement.on('click', '.entry-display', function(ev) {
          var $this = $(ev.currentTarget);
        }.bind(this));

        var dragState = {
          el : null,
          time : 0,
          startX : 0,
          startY : 0,
          isDragging : false
        };

        $(document).on('mousedown', '.entry-display', function(ev) {
          var $this = $(ev.currentTarget);

          var entry = $this.data('entry');
          this.selectEntry(entry);

          dragState = {
            el : $this,
            time : new Date().getTime(),
            startX : ev.pageX,
            startY : ev.pageY,
            isDragging : false
          };
          console.log('Drag state set');
        }.bind(this));

        $(document).on('mouseup', function(ev) {

          dragState.el.css('border', 'none');

          dragState.time = 0;
          dragState.el = null;
          dragState.isDragging = false;

          console.log('Drag state cleared');
        }.bind(this));

        $(document).on('mousemove', function(ev) {
          if (!dragState.el)
            return;

          if (!dragState.isDragging) {
            var diffX = Math.pow(ev.pageX - dragState.startX, 2);
            var diffY = Math.pow(ev.pageY - dragState.startY, 2);
            var diff = Math.sqrt(diffX + diffY);

            if (diff > 4) {
              dragState.isDragging = true;

            } else {
              return;
            }
          }

          if (dragState.isDragging) {
            dragState.el.css('border', '5px solid red');
          }
        }.bind(this));

        // Expand on double click
        this.domElement.on('click', '.entry-display', function(ev) {
          var $this = $(ev.currentTarget);

          var now = new Date().getTime();
          if (now - $this.data('lastclick') < 300) {
            var entry = $this.data('entry');

            if (entry.data('filetype') == 'dir') {
              this.toggleFolder(entry);
            } else {
              this.previewAsset(entry);
            }

            $this.data('lastclick', 0);
          } else {
            $this.data('lastclick', now);
          }
        }.bind(this));

        // Expander mouse handling
        this.domElement.on('click', '.expander', function(ev) {
          var $this = $(ev.currentTarget);

          var folder = $this.data('entry');
          this.toggleFolder(folder);
        }.bind(this))

        this.refreshFolder();
      }

      AssetManager.prototype.previewAsset = function(entry) {
        parent.postMessage({
          cmd : 'toggleWindow',
          callerid : 'null',
          width : 400,
          height : 400,
          title : 'Asset Previewer<div style="font-size: 8px; position: absolute; opacity: 0">' + entry.data('uuid') + '<div>',
          page : 'apps/assetmgr/preview.html?uuid=' + entry.data('uuid') + '&filetype=' + entry.data('filetype'),
          spawnx : '10vw',
          spawny : '20vh'
        }, '*');
      }

      AssetManager.prototype.selectEntry = function(entry) {

        this.domElement.find('.active').removeClass('active');
        entry.children('.entry-display').addClass('active');

        if (entry.data('filetype') == 'dir')
          return;
        $('.url-output').val(this.getAssetURL(entry));
      }

      AssetManager.prototype.getAssetURL = function(entry) {
        var uuid = entry.data('uuid');
        return this.baseurl + 'asset/get/' + uuid;
      }

      AssetManager.prototype.isFolderLoaded = function(folder) {
        return folder.data('loaded') === true;
      }

      AssetManager.prototype.toggleFolder = function(folder) {
        if (folder.hasClass('expanded')) {
          this.collapseFolder(folder);
        } else {
          this.expandFolder(folder);
        }
      }

      AssetManager.prototype.expandFolder = function(folder) {
        folder.addClass('expanded');

        if (!this.isFolderLoaded(folder)) {
          this.refreshFolder(folder);
        }
      }

      AssetManager.prototype.collapseFolder = function(folder) {
        folder.removeClass('expanded');
      }

      AssetManager.prototype.refreshFolder = function(folder, cb) {
        cb = cb || function() {};

        if (!folder)
          folder = this.domElement;

        // No sublist, create one
        if (folder.children('ul').length == 0) {
          folder.append('<ul></ul>');
        }

        var list = folder.children('ul');

        var loading;
        // Does sublist have children? If not, add "loading"
        if (list.children().length == 0) {
          loading = $('<li>Loading...</li>');
          loading.addClass('loader');
          list.append(loading);
        }
        var uuid = folder.data('uuid');

        getJSON(this.baseurl + 'asset/list/' + (uuid ? uuid : ''), function(data) {
          list.children('.loader').remove();
          if (folder.data('loaded')) {
            list.empty();
          } else {
            folder.data('loaded', true);
          }

          if (loading)
            loading.remove();

          for (var i in data.children) {
            var entryData = data.children[i];

            var entry = $('<li></li>');
            entry.addClass('entry');

            entry.data('filetype', entryData.filetype);
            entry.data('filename', entryData.filename);
            entry.data('mimetype', entryData.mimetype);
            entry.data('uuid', entryData.uuid);

            var entryDisplay = $('<div/>');
            entryDisplay.addClass('entry-display');
            entryDisplay.data('entry', entry);

            entry.append(entryDisplay);

            var icon = $('<span/>');
            icon.addClass('icon');

            switch (entryData.filetype) {
              case 'txt':
                icon.addClass('icon-document');
              break;

              case 'dir':
                icon.addClass('icon-folder');
              break;

              case 'png':
              case 'gif':
              case 'jpg':
                icon.addClass('icon-image');

              break;

              case 'obj':
              case 'dae':
              case 'fbx':
                icon.addClass('icon-model');
              break;
              default:
                icon.addClass('icon-file');
              break
            }

            entryDisplay.text(entryData.filename);
            entryDisplay.prepend(icon);


            if (entryData.filetype == 'dir') {
              var expander = $('<div/>');
              expander.data('entry', entry);
              expander.addClass('icon expander');
              entry.prepend(expander);
              /*if (Math.random() > 0.6) {
                var target = li;
                this.refreshFolder(target, function() {
                  this.expandFolder(target);
                }.bind(this));
              }*/
              //li.addClass('expanded');
            } else {


            }

            list.append(entry);
          }

          cb();
        }.bind(this));
      }

      var callbacks = {};
      function onJSON(id, cb) {
        callbacks[id] = cb;
      }

      function getJSON(url, cb) {
        var id = Math.random();
        callbacks[id] = cb;

        if (url.search(/\?/) == -1) {
          url += '?rid=' + id;
        } else {
          url += '&rid=' + id;
        }
        var script = $("<script />", {
          src: url,
          type: "application/javascript"
        });

        $('head').append(script);
      }

      function consumeJSON(id, json) {
        if (callbacks[id])
          callbacks[id](json);
      }

      var assetMgr;
      $(document).ready(function() {
        assetMgr = new AssetManager({
          target: $('.assets-container'),
          host: 'strandedin.space',
          port: 8081
        });
      });
    </script>
  </head>
  <body>
    <div class="windowcontainer">
      <div class="windowarea unselectable" id="windowarea">
        <table>
          <tbody>
            <tr>
              <td>
                <input type='button' value='Reload' onclick='window.location.reload()'/>
                <form id='uploadform' action='http://strandedin.space:8081/asset/upload/' method='post' encType='multipart/form-data'>
            			<input type="file" name="assetfile" id="assetfile" style='display:none'>
                  <input type="button" value="Upload File..." onclick="document.getElementById('assetfile').click();" />
            		</form>
                <label>Selected asset URL</label>
                <input type='text' class='url-output' placeholder='Choose an asset below' style='width: 100%'/>
              </td>
            </tr>
            <tr>
              <td>
                <div class='assets-container'>
                  <div class='assets-title'></div>
                  <ul class='assets-list'>
                  </ul>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <audio id="sound1" src="..\..\..\sounds\click.wav" preload="auto"></audio>
    <audio id="sound2" src="levelup.wav" preload="auto"></audio>
  </body>
</html>
